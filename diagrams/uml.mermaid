classDiagram

%% Core Interfaces
class Identifier
class IdGenerator
class BaseModel
class Usecase

%% User Domain
class User
User : +id Identifier
User : +email string
User : +phone string
User : +password string
User : +role Identifier
User : +status UserStatus
User : +language Language
User : +deleted boolean

class UserRepository
UserRepository : +create(user)
UserRepository : +save(entity)
UserRepository : +findByEmail(email)
UserRepository : +findById(id)
UserRepository : +getUsers(filter, sort, limit, skip)
UserRepository : +searchByFields(query, limit, skip)

class UserService
UserService : +create(params)
UserService : +validateUser(params)
UserService : +updateRefreshToken(user, token)
UserService : +changePassword(user, password)
UserService : +getUsers(params)
UserService : +search(query)
UserService : +getById(id)
UserService : +deleteById(id)
UserService : +update(user, params)
UserService : +findByEmail(email)

%% Role Domain
class Role
Role : +id Identifier
Role : +name MultiLanguage
Role : +alias RoleAlias

class RoleRepository
RoleRepository : +findByAlias(alias)
RoleRepository : +findById(id)
RoleRepository : +getAll()
RoleRepository : +getTopRoles()

class RoleService
RoleService : +findByAlias(alias)
RoleService : +findById(id)
RoleService : +getAll()
RoleService : +getTopRoles()
RoleService : +isTopRole(roleAlias)

%% Category Domain
class Category
Category : +id Identifier
Category : +title MultiLanguage
Category : +alias string
Category : +color string
Category : +icon string
Category : +userId Identifier
Category : +status CategoryStatus
Category : +deleted boolean

class CategoryRepository
CategoryRepository : +create(category)
CategoryRepository : +save(category)
CategoryRepository : +findAllByUser(userId)
CategoryRepository : +findById(id)
CategoryRepository : +updateById(id, update)
CategoryRepository : +updateOne(filter, update)

class CategoryService
CategoryService : +validateOwnership(category, userId)
CategoryService : +create(params)
CategoryService : +getById(id)
CategoryService : +deleteById(id)
CategoryService : +update(category, params)
CategoryService : +findAllByUser(userId)
CategoryService : +incrementUsage(categoryId, lastUsage)

%% Category Budget Domain
class CategoryBudget
CategoryBudget : +id Identifier
CategoryBudget : +userId Identifier
CategoryBudget : +categoryId Identifier
CategoryBudget : +period BudgetPeriod
CategoryBudget : +plannedAmount number
CategoryBudget : +limitAmount number
CategoryBudget : +currency Currency
CategoryBudget : +note string
CategoryBudget : +status CategoryBudgetStatus
CategoryBudget : +deleted boolean
CategoryBudget : +spent number

class CategoryBudgetRepository
CategoryBudgetRepository : +create(categoryBudget)
CategoryBudgetRepository : +save(categoryBudget)
CategoryBudgetRepository : +findAllByUser(userId)
CategoryBudgetRepository : +findById(id)
CategoryBudgetRepository : +updateById(id, update)
CategoryBudgetRepository : +updateOne(filter, update)
CategoryBudgetRepository : +findOneByUserCategoryPeriod(params)
CategoryBudgetRepository : +findByPeriod(params)
CategoryBudgetRepository : +archiveByCategory(categoryId)

class CategoryBudgetService
CategoryBudgetService : +create(params)
CategoryBudgetService : +findByPeriod(userId, period)
CategoryBudgetService : +getById(id)
CategoryBudgetService : +deleteById(id)
CategoryBudgetService : +validateOwnership(budget, userId)
CategoryBudgetService : +save(entity)
CategoryBudgetService : +archiveByCategory(categoryId)

%% Transaction Domain
class Transaction
Transaction : +id Identifier
Transaction : +title string
Transaction : +note string
Transaction : +amount number
Transaction : +currency Currency
Transaction : +userId Identifier
Transaction : +categoryId Identifier
Transaction : +type TransactionType
Transaction : +occurredAt Date
Transaction : +deleted boolean

class TransactionRepository
TransactionRepository : +create(transaction)
TransactionRepository : +save(transaction)
TransactionRepository : +findAllByUser(userId)
TransactionRepository : +findPaginatedByUser(params)
TransactionRepository : +findAllByCategory(userId, categoryId)
TransactionRepository : +findById(id)
TransactionRepository : +getExpenseSummaryByCategory(params)
TransactionRepository : +getSpentByCategoryAndPeriod(userId, categoryId, year, month)
TransactionRepository : +updateById(id, update)
TransactionRepository : +updateOne(filter, update)

class TransactionService
TransactionService : +validateOwnership(transaction, userId)
TransactionService : +create(params)
TransactionService : +getById(id)
TransactionService : +deleteById(id)
TransactionService : +update(transaction, params)
TransactionService : +findAllByUser(userId)
TransactionService : +findPaginatedByUser(params)
TransactionService : +getExpenseSummaryByCategory(params)
TransactionService : +getSpentByCategoryAndPeriod(params)

%% Audit Log Domain
class AuditLog
AuditLog : +id Identifier
AuditLog : +occurredAt Date
AuditLog : +actorType Actor
AuditLog : +actorUserId Identifier
AuditLog : +targetEntity TargetEntity
AuditLog : +targetId Identifier
AuditLog : +category AuditCategory
AuditLog : +type AuditType
AuditLog : +message MultiLanguage
AuditLog : +metadata Record

class AuditLogRepository
AuditLogRepository : +create(audit)
AuditLogRepository : +save(audit)
AuditLogRepository : +findById(id)
AuditLogRepository : +getAuditLogs(filter, sort, limit, skip)
AuditLogRepository : +getAll(limit, skip)

class AuditLogService
AuditLogService : +log(params, context)
AuditLogService : +getById(id)
AuditLogService : +getAuditLogs(params)
AuditLogService : +save(auditLog)
AuditLogService : +getAll()

class LogEnricherService
LogEnricherService : +enrich(auditLog)

%% Usecases - Transactions
class CreateTransactionUsecase
class GetTransactionsUsecase
class DeleteTransactionUsecase

%% Usecases - Categories
class CreateCategoryUsecase
class GetCategoriesUsecase
class UpdateCategoryUsecase
class DeleteCategoryUsecase
class SuggestCategoryUsecase

%% Usecases - Category Budgets
class CreateCategoryBudgetUsecase
class GetCategoryBudgetsUsecase
class UpdateCategoryBudgetUsecase

%% Usecases - Auth
class LoginUsecase
class GetMeUsecase
class ChangePasswordUsecase

%% Usecases - Users
class CreateUserUsecase
class GetUsersUsecase
class GetUserUsecase
class DeleteUserUsecase
class SearchUsersUsecase
class UpdateUserUsecase

%% Usecases - Audit Logs
class GetAuditLogsUsecase
class GetAuditLogUsecase

%% Core Services
class JwtService
class Hasher
class CurrentUserService
class LlmProvider
class SlugService
class TranslateService

%% Relationships: Repositories to Entities
UserRepository --> User
RoleRepository --> Role
CategoryRepository --> Category
CategoryBudgetRepository --> CategoryBudget
TransactionRepository --> Transaction
AuditLogRepository --> AuditLog

%% Relationships: Services to Repositories
UserService --> UserRepository
UserService --> RoleService
RoleService --> RoleRepository
CategoryService --> CategoryRepository
CategoryService --> TranslateService
CategoryService --> SlugService
CategoryBudgetService --> CategoryBudgetRepository
TransactionService --> TransactionRepository
AuditLogService --> AuditLogRepository

%% Relationships: Service to Service
UserService --> CurrentUserService
TransactionService --> CategoryService

%% Relationships: Usecases to Services
CreateTransactionUsecase --> TransactionService
GetTransactionsUsecase --> TransactionService
DeleteTransactionUsecase --> TransactionService
CreateCategoryUsecase --> CategoryService
GetCategoriesUsecase --> CategoryService
UpdateCategoryUsecase --> CategoryService
DeleteCategoryUsecase --> CategoryService
DeleteCategoryUsecase --> CategoryBudgetService
SuggestCategoryUsecase --> LlmProvider
SuggestCategoryUsecase --> CategoryService
CreateCategoryBudgetUsecase --> CategoryBudgetService
GetCategoryBudgetsUsecase --> CategoryBudgetService
GetCategoryBudgetsUsecase --> TransactionService
UpdateCategoryBudgetUsecase --> CategoryBudgetService
LoginUsecase --> UserService
LoginUsecase --> JwtService
LoginUsecase --> Hasher
GetMeUsecase --> CurrentUserService
ChangePasswordUsecase --> UserService
ChangePasswordUsecase --> Hasher
CreateUserUsecase --> UserService
GetUsersUsecase --> UserService
GetUserUsecase --> UserService
DeleteUserUsecase --> UserService
UpdateUserUsecase --> UserService
SearchUsersUsecase --> UserService
GetAuditLogsUsecase --> AuditLogService
GetAuditLogUsecase --> AuditLogService

%% Feature notes
note for CategoryBudget "With spent enrichment from TransactionService"
note for GetCategoryBudgetsUsecase "Enriches budgets with spent via getSpentByCategoryAndPeriod"
note for TransactionService "Includes getSpentByCategoryAndPeriod for budget enrichment"


